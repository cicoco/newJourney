# 后端架构设计说明V2

## 1. 技术选型

### 1.1 核心技术栈
- **运行环境**: Node.js 18.0+
- **Web框架**: Express.js 4.18+
- **数据库**: SQLite3 3.40+
- **ORM**: Sequelize 6.35+
- **认证**: JWT (jsonwebtoken 9.0+)
- **密码加密**: bcryptjs 2.4+
- **参数验证**: Joi 17.11+
- **日志**: Winston 3.11+

### 1.2 选择理由
- Node.js轻量高效，适合2核2G服务器
- SQLite3无需额外数据库服务，部署简单
- Express.js成熟稳定，生态丰富
- 整体技术栈轻量，资源占用少

## 2. 工程结构

```
src/
├── config/                 # 配置文件
├── models/                 # 数据模型
├── controllers/           # 控制器层
├── services/              # 业务逻辑层
├── middlewares/           # 中间件
├── routes/                # 路由层
├── utils/                 # 工具函数
├── database/              # 数据库相关
├── app.js                # 应用入口
└── server.js             # 服务器启动
```

## 3. 数据库设计

### 3.1 用户表 (users)
```sql
CREATE TABLE users (
  id VARCHAR(36) PRIMARY KEY,
  username VARCHAR(20) UNIQUE NOT NULL,
  nickname VARCHAR(20) NOT NULL,
  password VARCHAR(255) NOT NULL,
  email VARCHAR(100),
  enabled BOOLEAN DEFAULT false,
  role INTEGER DEFAULT 0,
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  lastLogin DATETIME,
  CONSTRAINT chk_role CHECK (role IN (0, 1, 2, 3))
);
```

### 3.2 资源表 (resources)
```sql
CREATE TABLE resources (
  id VARCHAR(36) PRIMARY KEY,
  externalId VARCHAR(100),
  from INTEGER NOT NULL,
  title VARCHAR(500) NOT NULL,
  url TEXT NOT NULL,
  content TEXT,
  description TEXT,
  time DATETIME NOT NULL,
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT chk_from CHECK (from IN (0, 1))
);
```

### 3.3 文章表 (articles)
```sql
CREATE TABLE articles (
  id VARCHAR(36) PRIMARY KEY,
  title VARCHAR(100) NOT NULL,
  content TEXT,
  description VARCHAR(300),
  authors TEXT NOT NULL,
  status INTEGER DEFAULT 0,
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT chk_status CHECK (status IN (0, 9))
);
```

### 3.4 文章资源关联表 (article_resources)
```sql
CREATE TABLE article_resources (
  id VARCHAR(36) PRIMARY KEY,
  articleId VARCHAR(36) NOT NULL,
  resourceId VARCHAR(36) NOT NULL,
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (articleId) REFERENCES articles(id) ON DELETE CASCADE,
  FOREIGN KEY (resourceId) REFERENCES resources(id) ON DELETE CASCADE,
  UNIQUE(articleId, resourceId)
);
```

## 4. 接口设计

### 4.1 统一响应格式
```javascript
{
  "code": 0,           // 状态码，0表示成功
  "message": "",       // 消息描述
  "data": {}           // 业务数据
}
```

### 4.2 认证接口

#### 4.2.1 用户登录
```javascript
// POST /api/auth/login
{
  "username": "string",
  "password": "string"
}

// 响应
{
  "code": 0,
  "message": "Success",
  "data": {
    "token": "jwt_token",
    "user": {
      "id": "uuid",
      "username": "string",
      "nickname": "string",
      "role": 0,
      "enabled": true
    },
    "expiresAt": 1234567890
  }
}
```

#### 4.2.2 用户注册
```javascript
// POST /api/auth/register
{
  "username": "string",
  "nickname": "string",
  "password": "string",
  "confirmPassword": "string",
  "email": "string"
}

// 响应
{
  "code": 0,
  "message": "注册成功，请等待管理员审核",
  "data": null
}
```

### 4.3 用户管理接口

#### 4.3.1 分页查询用户列表
```javascript
// GET /api/users?keyword=&current=1&size=10
// 权限: 系统管理员、超级管理员

// 响应
{
  "code": 0,
  "message": "Success",
  "data": {
    "records": [
      {
        "id": "uuid",
        "username": "string",
        "nickname": "string",
        "email": "string",
        "role": 0,
        "enabled": true,
        "createdAt": "2024-01-01T00:00:00.000Z"
      }
    ],
    "total": 100,
    "size": 10,
    "current": 1,
    "pages": 10
  }
}
```

### 4.4 资源管理接口

#### 4.4.1 分页查询资源列表
```javascript
// GET /api/resources?keyword=&from=&startTime=&endTime=&current=1&size=10
// 权限: 系统管理员、超级管理员、编辑

// 响应
{
  "code": 0,
  "message": "Success",
  "data": {
    "records": [
      {
        "id": "uuid",
        "externalId": "string",
        "from": 0,
        "title": "string",
        "url": "string",
        "description": "string",
        "time": "2024-01-01T00:00:00.000Z"
      }
    ],
    "total": 100,
    "size": 10,
    "current": 1,
    "pages": 10
  }
}
```

### 4.5 文章管理接口

#### 4.5.1 创建文章
```javascript
// POST /api/articles
// 权限: 系统管理员、超级管理员、编辑
{
  "title": "string",
  "content": "string",
  "description": "string",
  "resourceIds": ["uuid"]
}

// 响应
{
  "code": 0,
  "message": "创建成功",
  "data": {
    "id": "uuid",
    "title": "string",
    "status": 0,
    "createdAt": "2024-01-01T00:00:00.000Z"
  }
}
```

## 5. 权限控制设计

### 5.1 角色定义
```javascript
const ROLES = {
  NORMAL_USER: 0,      // 普通用户
  SYSTEM_ADMIN: 1,     // 系统管理员
  SUPER_ADMIN: 2,      // 超级管理员
  EDITOR: 3           // 编辑
};

const PERMISSIONS = {
  USER_LIST: [ROLES.SYSTEM_ADMIN, ROLES.SUPER_ADMIN],
  USER_EDIT: [ROLES.SYSTEM_ADMIN, ROLES.SUPER_ADMIN],
  RESOURCE_LIST: [ROLES.SYSTEM_ADMIN, ROLES.SUPER_ADMIN, ROLES.EDITOR],
  ARTICLE_CREATE: [ROLES.SYSTEM_ADMIN, ROLES.SUPER_ADMIN, ROLES.EDITOR]
};
```

## 6. 安全措施

### 6.1 认证安全
- JWT Token过期时间设置（24小时）
- 密码bcrypt加密存储
- 登录失败次数限制
- 注册频率限制

### 6.2 数据安全
- SQL注入防护
- XSS防护
- 参数验证和过滤
- 敏感信息脱敏

## 7. 错误处理

### 7.1 错误码定义
```javascript
const ERROR_CODES = {
  SUCCESS: 0,
  UNAUTHORIZED: 401,
  FORBIDDEN: 403,
  VALIDATION_ERROR: 40001,
  USER_NOT_FOUND: 40003,
  USER_DISABLED: 40002,
  USERNAME_EXISTS: 40004,
  PERMISSION_DENIED: 40006
};
```

## 8. 部署说明

### 8.1 环境要求
- Node.js 18.0+
- SQLite3 3.40+
- 内存: 2GB+
- 存储: 10GB+

### 8.2 部署步骤
```bash
npm install
npm run migrate
npm run seed
npm start
```

### 8.3 环境变量
```bash
NODE_ENV=production
PORT=3000
JWT_SECRET=your_jwt_secret
JWT_EXPIRES_IN=24h
```

## 9. 最佳实践说明

### 9.1 代码组织
- 分层架构（Controller-Service-Model）
- 依赖注入（模块解耦）
- 单一职责（功能模块化）

### 9.2 错误处理
- 统一错误格式
- 错误分类处理
- 错误日志记录
- 用户友好提示

### 9.3 性能优化
- 数据库查询优化
- 缓存策略
- 异步处理
- 资源管理

### 9.4 安全防护
- 输入验证
- 权限控制
- 数据加密
- 攻击防护