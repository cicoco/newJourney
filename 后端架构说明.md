# 后端架构设计说明

## 1. 技术选型

### 1.1 核心技术栈
- **运行环境**: Node.js 18.0+
- **Web框架**: Express.js 4.18+
- **数据库**: SQLite3 3.40+
- **ORM**: Sequelize 6.35+
- **认证**: JWT (jsonwebtoken 9.0+)
- **密码加密**: bcryptjs 2.4+
- **参数验证**: Joi 17.11+
- **日志**: Winston 3.11+
- **文件上传**: Multer 1.4+

### 1.2 开发工具
- **代码规范**: ESLint + Prettier
- **类型检查**: TypeScript 5.0+
- **测试框架**: Jest 29.7+
- **API文档**: Swagger/OpenAPI 3.0
- **进程管理**: PM2 5.3+

### 1.3 选择理由
- Node.js轻量高效，适合2核2G服务器
- SQLite3无需额外数据库服务，部署简单
- Express.js成熟稳定，生态丰富
- 整体技术栈轻量，资源占用少

## 2. 工程结构

```
src/
├── config/                 # 配置文件
│   ├── database.js         # 数据库配置
│   ├── jwt.js             # JWT配置
│   ├── app.js             # 应用配置
│   └── index.js           # 配置统一导出
├── models/                 # 数据模型
│   ├── index.js           # 模型关联
│   ├── User.js            # 用户模型
│   ├── Resource.js        # 资源模型
│   ├── Article.js         # 文章模型
│   └── ArticleResource.js # 文章资源关联模型
├── controllers/           # 控制器层
│   ├── authController.js  # 认证控制器
│   ├── userController.js  # 用户控制器
│   ├── resourceController.js # 资源控制器
│   └── articleController.js  # 文章控制器
├── services/              # 业务逻辑层
│   ├── authService.js     # 认证服务
│   ├── userService.js     # 用户服务
│   ├── resourceService.js # 资源服务
│   └── articleService.js  # 文章服务
├── middlewares/           # 中间件
│   ├── auth.js           # 认证中间件
│   ├── permission.js     # 权限中间件
│   ├── validation.js     # 参数验证中间件
│   ├── rateLimit.js      # 频率限制中间件
│   ├── errorHandler.js   # 错误处理中间件
│   └── logger.js         # 日志中间件
├── routes/                # 路由层
│   ├── index.js          # 路由统一导出
│   ├── auth.js           # 认证路由
│   ├── user.js           # 用户路由
│   ├── resource.js       # 资源路由
│   └── article.js        # 文章路由
├── utils/                 # 工具函数
│   ├── response.js       # 响应格式化
│   ├── validator.js      # 验证工具
│   ├── crypto.js         # 加密工具
│   ├── logger.js         # 日志工具
│   └── helper.js         # 辅助函数
├── database/              # 数据库相关
│   ├── migrations/       # 数据库迁移
│   └── seeders/          # 数据种子
├── app.js                # 应用入口
└── server.js             # 服务器启动
```

## 3. 数据库设计

### 3.1 数据库配置
```javascript
// config/database.js
module.exports = {
  development: {
    dialect: 'sqlite',
    storage: './database/development.sqlite',
    logging: console.log
  },
  production: {
    dialect: 'sqlite',
    storage: './database/production.sqlite',
    logging: false
  }
}
```

### 3.2 数据表设计

#### 3.2.1 用户表 (users)
```sql
CREATE TABLE users (
  id VARCHAR(36) PRIMARY KEY,
  username VARCHAR(20) UNIQUE NOT NULL,
  nickname VARCHAR(20) NOT NULL,
  password VARCHAR(255) NOT NULL,
  email VARCHAR(100),
  enabled BOOLEAN DEFAULT false,
  role INTEGER DEFAULT 0,
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  lastLogin DATETIME,
  CONSTRAINT chk_role CHECK (role IN (0, 1, 2, 3)),
  CONSTRAINT chk_username_length CHECK (length(username) BETWEEN 6 AND 20),
  CONSTRAINT chk_nickname_length CHECK (length(nickname) BETWEEN 1 AND 20)
);

-- 索引
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_enabled ON users(enabled);
```

#### 3.2.2 资源表 (resources)
```sql
CREATE TABLE resources (
  id VARCHAR(36) PRIMARY KEY,
  externalId VARCHAR(100),
  source INTEGER NOT NULL,
  title VARCHAR(500) NOT NULL,
  url TEXT NOT NULL,
  content TEXT,
  description TEXT,
  time DATETIME NOT NULL,
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT chk_source CHECK (source IN (0, 1))
);

-- 索引
CREATE INDEX idx_resources_source ON resources(source);
CREATE INDEX idx_resources_time ON resources(time);
CREATE INDEX idx_resources_title ON resources(title);
```

#### 3.2.3 文章表 (articles)
```sql
CREATE TABLE articles (
  id VARCHAR(36) PRIMARY KEY,
  title VARCHAR(100) NOT NULL,
  content TEXT,
  description VARCHAR(300),
  authors TEXT NOT NULL,
  status INTEGER DEFAULT 0,
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT chk_status CHECK (status IN (0, 9)),
  CONSTRAINT chk_title_length CHECK (length(title) <= 100),
  CONSTRAINT chk_description_length CHECK (length(description) <= 300)
);

-- 索引
CREATE INDEX idx_articles_status ON articles(status);
CREATE INDEX idx_articles_createdAt ON articles(createdAt);
```

#### 3.2.4 文章资源关联表 (article_resources)
```sql
CREATE TABLE article_resources (
  id VARCHAR(36) PRIMARY KEY,
  articleId VARCHAR(36) NOT NULL,
  resourceId VARCHAR(36) NOT NULL,
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (articleId) REFERENCES articles(id) ON DELETE CASCADE,
  FOREIGN KEY (resourceId) REFERENCES resources(id) ON DELETE CASCADE,
  UNIQUE(articleId, resourceId)
);

-- 索引
CREATE INDEX idx_article_resources_articleId ON article_resources(articleId);
CREATE INDEX idx_article_resources_resourceId ON article_resources(resourceId);
```

### 3.3 数据模型定义

#### 3.3.1 用户模型
```javascript
// models/User.js
const { DataTypes } = require('sequelize');

module.exports = (sequelize) => {
  const User = sequelize.define('User', {
    id: {
      type: DataTypes.UUID,
      defaultValue: DataTypes.UUIDV4,
      primaryKey: true
    },
    username: {
      type: DataTypes.STRING(20),
      allowNull: false,
      unique: true,
      validate: {
        len: [6, 20]
      }
    },
    nickname: {
      type: DataTypes.STRING(20),
      allowNull: false,
      validate: {
        len: [1, 20]
      }
    },
    password: {
      type: DataTypes.STRING(255),
      allowNull: false
    },
    email: {
      type: DataTypes.STRING(100),
      allowNull: true,
      validate: {
        isEmail: true
      }
    },
    enabled: {
      type: DataTypes.BOOLEAN,
      defaultValue: false
    },
    role: {
      type: DataTypes.INTEGER,
      defaultValue: 0,
      validate: {
        isIn: [[0, 1, 2, 3]]
      }
    },
    lastLogin: {
      type: DataTypes.DATE,
      allowNull: true
    }
  }, {
    tableName: 'users',
    timestamps: true,
    createdAt: 'createdAt',
    updatedAt: 'updatedAt'
  });

  return User;
};
```

## 4. 接口设计

### 4.1 认证接口

#### 4.1.1 用户登录
```javascript
// POST /api/auth/login
{
  "username": "string", // 必填，6-20位
  "password": "string"  // 必填，6-20位
}

// 响应
{
  "code": 0,
  "message": "Success",
  "data": {
    "token": "jwt_token",
    "user": {
      "id": "uuid",
      "username": "string",
      "nickname": "string",
      "role": 0,
      "enabled": true
    },
    "expiresAt": 1234567890
  }
}
```

#### 4.1.2 用户注册
```javascript
// POST /api/auth/register
{
  "username": "string",        // 必填，6-20位，唯一
  "nickname": "string",        // 必填，1-20位
  "password": "string",        // 必填，6-20位
  "confirmPassword": "string", // 必填，与password一致
  "email": "string"           // 可选，邮箱格式
}

// 响应
{
  "code": 0,
  "message": "注册成功，请等待管理员审核",
  "data": null
}
```

### 4.2 用户管理接口

#### 4.2.1 分页查询用户列表
```javascript
// GET /api/users?keyword=&current=1&size=10
// 权限: 系统管理员、超级管理员

// 响应
{
  "code": 0,
  "message": "Success",
  "data": {
    "records": [
      {
        "id": "uuid",
        "username": "string",
        "nickname": "string",
        "email": "string",
        "role": 0,
        "enabled": true,
        "createdAt": "2024-01-01T00:00:00.000Z",
        "lastLogin": "2024-01-01T00:00:00.000Z"
      }
    ],
    "total": 100,
    "size": 10,
    "current": 1,
    "pages": 10
  }
}
```

#### 4.2.2 修改用户信息
```javascript
// PUT /api/users/:id
// 权限: 系统管理员、超级管理员
{
  "nickname": "string",  // 可选
  "email": "string",     // 可选
  "password": "string",  // 可选
  "role": 0,            // 可选，0-3
  "enabled": true       // 可选
}
```

### 4.3 资源管理接口

#### 4.3.1 分页查询资源列表
```javascript
// GET /api/resources?keyword=&from=&startTime=&endTime=&current=1&size=10
// 权限: 系统管理员、超级管理员、编辑

// 响应
{
  "code": 0,
  "message": "Success",
  "data": {
    "records": [
      {
        "id": "uuid",
        "externalId": "string",
        "source": 0,
        "title": "string",
        "url": "string",
        "description": "string",
        "time": "2024-01-01T00:00:00.000Z",
        "createdAt": "2024-01-01T00:00:00.000Z"
      }
    ],
    "total": 100,
    "size": 10,
    "current": 1,
    "pages": 10
  }
}
```

### 4.4 文章管理接口

#### 4.4.1 创建文章
```javascript
// POST /api/articles
// 权限: 系统管理员、超级管理员、编辑
{
  "title": "string",        // 必填，1-100位
  "content": "string",      // 可选
  "description": "string",  // 可选，1-300位
  "resourceIds": ["uuid"]   // 可选，资源ID数组
}

// 响应
{
  "code": 0,
  "message": "创建成功",
  "data": {
    "id": "uuid",
    "title": "string",
    "status": 0,
    "createdAt": "2024-01-01T00:00:00.000Z"
  }
}
```

## 5. 权限控制设计

### 5.1 角色定义
```javascript
const ROLES = {
  NORMAL_USER: 0,      // 普通用户
  SYSTEM_ADMIN: 1,     // 系统管理员
  SUPER_ADMIN: 2,      // 超级管理员
  EDITOR: 3           // 编辑
};

const PERMISSIONS = {
  // 用户管理权限
  USER_LIST: [ROLES.SYSTEM_ADMIN, ROLES.SUPER_ADMIN],
  USER_EDIT: [ROLES.SYSTEM_ADMIN, ROLES.SUPER_ADMIN],
  USER_DELETE: [ROLES.SYSTEM_ADMIN, ROLES.SUPER_ADMIN],
  
  // 资源管理权限
  RESOURCE_LIST: [ROLES.SYSTEM_ADMIN, ROLES.SUPER_ADMIN, ROLES.EDITOR],
  RESOURCE_VIEW: [ROLES.SYSTEM_ADMIN, ROLES.SUPER_ADMIN, ROLES.EDITOR],
  
  // 文章管理权限
  ARTICLE_LIST: [ROLES.SYSTEM_ADMIN, ROLES.SUPER_ADMIN, ROLES.EDITOR],
  ARTICLE_CREATE: [ROLES.SYSTEM_ADMIN, ROLES.SUPER_ADMIN, ROLES.EDITOR],
  ARTICLE_EDIT: [ROLES.SYSTEM_ADMIN, ROLES.SUPER_ADMIN, ROLES.EDITOR],
  ARTICLE_DELETE: [ROLES.SYSTEM_ADMIN, ROLES.SUPER_ADMIN]
};
```

### 5.2 权限中间件
```javascript
// middlewares/permission.js
const checkPermission = (permission) => {
  return (req, res, next) => {
    const userRole = req.user.role;
    const allowedRoles = PERMISSIONS[permission];
    
    if (!allowedRoles || !allowedRoles.includes(userRole)) {
      return res.status(403).json({
        code: 40006,
        message: "权限不足"
      });
    }
    
    next();
  };
};
```

## 6. 安全措施

### 6.1 认证安全
- JWT Token过期时间设置
- Refresh Token机制
- 密码bcrypt加密存储
- 登录失败次数限制

### 6.2 数据安全
- SQL注入防护
- XSS防护
- 参数验证和过滤
- 敏感信息脱敏

### 6.3 接口安全
- 请求频率限制
- CORS配置
- 请求大小限制
- 错误信息脱敏

### 6.4 业务安全
- 角色权限验证
- 数据所有权验证
- 操作日志记录
- 敏感操作确认

## 7. 错误处理

### 7.1 错误码定义
```javascript
const ERROR_CODES = {
  SUCCESS: 0,
  UNAUTHORIZED: 401,
  FORBIDDEN: 403,
  NOT_FOUND: 404,
  VALIDATION_ERROR: 40001,
  USER_NOT_FOUND: 40003,
  USER_DISABLED: 40002,
  USERNAME_EXISTS: 40004,
  INVALID_EMAIL: 40005,
  PERMISSION_DENIED: 40006,
  RESOURCE_NOT_FOUND: 50002,
  OPERATION_FAILED: 50003
};
```

### 7.2 全局错误处理
```javascript
// middlewares/errorHandler.js
const errorHandler = (err, req, res, next) => {
  logger.error(err);
  
  if (err.name === 'ValidationError') {
    return res.status(400).json({
      code: 40001,
      message: err.message
    });
  }
  
  if (err.name === 'SequelizeUniqueConstraintError') {
    return res.status(400).json({
      code: 40004,
      message: '数据已存在'
    });
  }
  
  res.status(500).json({
    code: 50003,
    message: '服务器内部错误'
  });
};
```

## 8. 性能优化

### 8.1 数据库优化
- 合理使用索引
- 查询优化
- 连接池配置
- 分页查询优化

### 8.2 缓存策略
- Redis缓存热点数据
- 内存缓存配置信息
- 静态资源缓存
- API响应缓存

### 8.3 并发处理
- 异步处理
- 队列机制
- 连接池管理
- 负载均衡

## 9. 日志管理

### 9.1 日志配置
```javascript
// utils/logger.js
const winston = require('winston');

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'logs/error.log', level: 'error' }),
    new winston.transports.File({ filename: 'logs/combined.log' })
  ]
});
```

### 9.2 日志内容
- 访问日志
- 错误日志
- 操作日志
- 性能日志

## 10. 部署说明

### 10.1 环境要求
- Node.js 18.0+
- SQLite3 3.40+
- 内存: 2GB+
- 存储: 10GB+

### 10.2 部署步骤
```bash
# 安装依赖
npm install

# 数据库迁移
npm run migrate

# 数据种子
npm run seed

# 启动服务
npm start

# PM2部署
pm2 start ecosystem.config.js
```

### 10.3 环境变量
```bash
NODE_ENV=production
PORT=3000
JWT_SECRET=your_jwt_secret
JWT_EXPIRES_IN=24h
RATE_LIMIT_WINDOW=15m
RATE_LIMIT_MAX=100
```

### 10.4 监控告警
- 服务状态监控
- 性能指标监控
- 错误率监控
- 资源使用监控

## 11. 测试策略

### 11.1 单元测试
- 业务逻辑测试
- 工具函数测试
- 模型测试
- 服务层测试

### 11.2 集成测试
- API接口测试
- 数据库操作测试
- 认证授权测试
- 错误处理测试

### 11.3 性能测试
- 并发测试
- 压力测试
- 内存泄漏测试
- 响应时间测试

## 12. 开发规范

### 12.1 代码规范
- ESLint + Prettier
- 命名规范
- 注释规范
- 文件组织规范

### 12.2 Git规范
- 分支管理策略
- 提交信息规范
- 代码审查流程
- 版本发布流程

### 12.3 文档规范
- API文档
- 数据库文档
- 部署文档
- 维护文档
